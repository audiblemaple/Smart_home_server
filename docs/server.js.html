<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: server.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: server.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @fileoverview This file includes the main server functionality.
 * @author Lior Jigalo
 * @version 1.0.0
 * @license MIT
 */

const express = require('express');
const app = express();
const cors = require('cors');
const routes = require('./routes');
const { readFileSync } = require("fs");
const fs = require('fs');
const e = require("express");
const WebSocket = require('ws');

const configController = require('./configController');

/**
 * Reads and parses the server configuration from a JSON file.
 */
const config = JSON.parse(readFileSync('serverConfig.json', 'utf8'));
let ws;

/**
 * Middleware setup for the Express application.
 * Includes JSON parser, CORS configuration, and API routes.
 */
app.use(express.json());
app.use(cors());
app.use('/api', routes);
app.use((req, res, next) => {
    res.header('Access-Control-Allow-Origin', '*'); // Adjust accordingly for production
    res.header('Access-Control-Allow-Headers', 'Origin, X-Requested-With, Content-Type, Accept');
    next();
});

/**
 * Server port configuration and initialization.
 */
const PORT = process.env.PORT || 3001;
app.listen(PORT, () => {
    console.log(`Server running on port ${PORT}`);
});

/**
 * Generates a timestamp in DD/MM/YY HH:MM:SS format.
 * @returns {string} The formatted timestamp.
 */
function getTimeStamp() {
    let now = new Date();
    let seconds = String(now.getSeconds()).padStart(2, '0');
    let minutes = String(now.getMinutes()).padStart(2, '0');
    let hours = String(now.getHours()).padStart(2, '0');
    let day = String(now.getDate()).padStart(2, '0');
    let month = String(now.getMonth() + 1).padStart(2, '0');
    let year = String(now.getFullYear()).slice(-2);
    return `${day}/${month}/${year} ${hours}:${minutes}:${seconds}`;
}

/**
 * Logs a message to a file with a timestamp.
 * @param {string} message - The message to be logged.
 */
function logMessage(message) {
    const timestamp = getTimeStamp();
    const logEntry = `${timestamp} -> ${message}\n`;
    console.log(logEntry);
    fs.appendFile('log.txt', logEntry, err => {
        if (err) {
            console.error('Error writing to log file', err);
        }
    });
}

/**
 * Initializes the WebSocket connection and sets up event handlers.
 */
function connect() {
    ws = new WebSocket(config.rootNodeWS);

    ws.on('open', function open() {
        console.log('WebSocket established');
    });

    ws.on('message', function incoming(data) {
        if ( data.includes("light_report") ){
            let messageArgs = data.split(":");
            configController.updateLight();
            console.log("light message");
        }
        logMessage(`${data}`);
    });

    ws.on('close', function close() {
        console.log('WebSocket connection dropped');
        // Reconnect after a delay
        setTimeout(() => {
            console.log('Attempting to reconnect...');
            connect();
        }, 2000); // Reconnect after 2 seconds
    });

    ws.on('error', function error(error) {
        console.error('WebSocket error:', error);
        ws.close(); // Ensure the 'close' event is triggered
    });
}

// Initial connection
connect();
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#PORT">PORT</a></li><li><a href="global.html#addHotspot">addHotspot</a></li><li><a href="global.html#config">config</a></li><li><a href="global.html#connect">connect</a></li><li><a href="global.html#fetchNodeIds">fetchNodeIds</a></li><li><a href="global.html#getConfig">getConfig</a></li><li><a href="global.html#getTimeStamp">getTimeStamp</a></li><li><a href="global.html#handleControlCommand">handleControlCommand</a></li><li><a href="global.html#logMessage">logMessage</a></li><li><a href="global.html#readConfig">readConfig</a></li><li><a href="global.html#sendCommand">sendCommand</a></li><li><a href="global.html#updateConfig">updateConfig</a></li><li><a href="global.html#updateLight">updateLight</a></li><li><a href="global.html#writeConfig">writeConfig</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.2</a> on Mon Jan 08 2024 23:07:41 GMT+0200 (Israel Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
